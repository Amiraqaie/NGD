name: Docker Image CI with Build Cache

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Set up Docker Buildx (for multi-platform and caching)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Log in to Docker Hub (or GHCR)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # # 4️⃣ Build and push image
      # - name: Build and Push Docker Image (with cache)
      #   uses: docker/build-push-action@v6
      #   with:
      #     context: .
      #     file: ./DockerFile/Dockerfile
      #     push: true
      #     tags: |
      #       ${{ secrets.DOCKERHUB_USERNAME }}/ngd_simulation:latest
      #       ${{ secrets.DOCKERHUB_USERNAME }}/ngd_simulation:${{ github.run_number }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      # --- 1️⃣ MicroXRCE ---
      - name: Build & Push MicroXRCE
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DockerFile/DockerfileMicroXRCE
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/microxrce:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/microxrce:${{ github.run_number }}
          cache-from: type=gha,scope=microxrce
          cache-to: type=gha,mode=max,scope=microxrce

      # purge unused data to reclaim space
      - name: Cleanup Docker space (after MicroXRCE)
        run: docker system prune -af


      # --- 2️⃣ OpenVINS ---
      - name: Build & Push OpenVINS
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DockerFile/DockerfileOpenVINS
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/openvins:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/openvins:${{ github.run_number }}
          cache-from: type=gha,scope=openvins
          cache-to: type=gha,mode=max,scope=openvins

      - name: Cleanup Docker space (after OpenVINS)
        run: docker system prune -af


      # --- 3️⃣ RtabMap ---
      - name: Build & Push RtabMap
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DockerFile/DockerfileRtabMap
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/rtabmap:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/rtabmap:${{ github.run_number }}
          cache-from: type=gha,scope=rtabmap
          cache-to: type=gha,mode=max,scope=rtabmap

      - name: Cleanup Docker space (after RtabMap)
        run: docker system prune -af


      # --- 4️⃣ Simulation ---
      - name: Build & Push Simulation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DockerFile/DockerfileSimulation
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/simulation:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/simulation:${{ github.run_number }}
          cache-from: type=gha,scope=simulation
          cache-to: type=gha,mode=max,scope=simulation
